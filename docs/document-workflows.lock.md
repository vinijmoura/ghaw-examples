# Document Workflows

## Overview

This workflow automatically creates or updates documentation for GitHub Actions workflows. Whenever a YML file is changed in the `.github/workflows/` folder on the `main` branch, it uses an AI agent (GitHub Copilot CLI) to generate or update a corresponding markdown documentation file in the `docs/` folder. The workflow is auto-generated by the gh-aw (GitHub Agentic Workflows) framework and should not be edited directly.

## Triggers

- **push** to the `main` branch, only when files matching `.github/workflows/*.yml` are changed

## Permissions

No top-level permissions are defined; permissions are scoped per job.

## Environment Variables

No workflow-level environment variables are defined.

## Jobs

### pre_activation

**Runs on**: `ubuntu-slim`

This job runs before `activation` to determine whether the workflow should proceed. It checks team membership to ensure only authorized users can trigger the agentic workflow.

**Steps**:

1. **Setup Scripts** – Installs gh-aw action scripts to `/opt/gh-aw/actions`.
2. **Check team membership for workflow** – Verifies that the actor who triggered the push is a member of the authorized team. Sets the `activated` output to `true` if authorized, `false` otherwise.

---

### activation

**Runs on**: `ubuntu-slim`  
**Needs**: `pre_activation`  
**Condition**: Only runs when `pre_activation` outputs `activated == 'true'`

**Permissions**: `contents: read`

This job validates context, assembles the agentic prompt, and uploads it for the `agent` job.

**Steps**:

1. **Setup Scripts** – Installs gh-aw action scripts to `/opt/gh-aw/actions`.
2. **Validate COPILOT_GITHUB_TOKEN secret** – Verifies the `COPILOT_GITHUB_TOKEN` secret is present and valid for authenticating the GitHub Copilot CLI engine.
3. **Validate context variables** – Ensures all required GitHub context variables (actor, repository, workspace, etc.) are present and valid before proceeding.
4. **Checkout .github and .agents folders** – Sparsely checks out only the `.github` and `.agents` directories to keep the checkout minimal.
5. **Check workflow file timestamps** – Validates that the workflow file (`document-workflows.lock.yml`) has not been tampered with or run out of order.
6. **Create prompt with built-in context** – Assembles the agentic prompt by concatenating built-in system prompts (XPIA protection, temp folder setup, markdown rules, safe outputs) with the workflow-specific documentation instructions and injecting GitHub context environment variables.
7. **Interpolate variables and render templates** – Processes Handlebars-style template directives in the prompt (e.g., `{{#runtime-import}}`), importing the `.github/workflows/document-workflows.md` task definition at runtime.
8. **Substitute placeholders** – Replaces `__GH_AW_*__` placeholder tokens in the prompt with actual runtime values (actor, repository, run ID, pre-activation outputs, etc.).
9. **Validate prompt placeholders** – Confirms that no unsubstituted placeholders remain in the final prompt.
10. **Print prompt** – Prints a summary of the final prompt to the Actions log for debugging.
11. **Upload prompt artifact** – Uploads the assembled prompt as an artifact so the `agent` job can download and execute it.

---

### agent

**Runs on**: `ubuntu-latest`  
**Needs**: `activation`

This job executes the AI agent (GitHub Copilot CLI) that reads the prepared prompt and performs the documentation task. It also runs threat detection on the agent's behavior.

**Steps**:

1. **Setup Scripts** – Installs gh-aw action scripts.
2. **Checkout repository** – Checks out the full repository so the agent can read workflow files and write documentation.
3. **Create gh-aw temp directory** – Creates `/tmp/gh-aw/agent/` as a writable workspace for temporary files.
4. **Configure Git credentials** – Sets up Git credentials (user name, email, token) so the agent can commit and push documentation changes.
5. **Checkout PR branch** – If this run is associated with a pull request, checks out the PR branch.
6. **Generate agentic run info** – Writes metadata about the current run (workflow name, run ID, actor) for the agent's context.
7. **Install GitHub Copilot CLI** – Installs the `gh copilot` CLI extension used to run the AI agent.
8. **Install awf binary** – Installs the `awf` (agentic workflow framework) binary that orchestrates agent execution.
9. **Determine automatic lockdown mode for GitHub MCP Server** – Checks whether to run the GitHub MCP Server in lockdown mode (restricted API access) based on workflow configuration.
10. **Download container images** – Pre-pulls container images required by the agent environment.
11. **Write Safe Outputs Config** – Writes the safe outputs configuration to disk, defining which output types (e.g., `create_pull_request`) are permitted.
12. **Generate Safe Outputs MCP Server Config** – Generates the MCP server configuration file for the safe outputs server.
13. **Start Safe Outputs MCP HTTP Server** – Starts a local HTTP server exposing safe output tools to the agent via the MCP protocol.
14. **Start MCP Gateway** – Starts the MCP gateway that routes tool calls between the agent and backend services while enforcing security and access policies.
15. **Generate workflow overview** – Produces a high-level description of the workflow for the agent's context.
16. **Download prompt artifact** – Downloads the prompt artifact assembled by the `activation` job.
17. **Clean git credentials** – Removes stored Git credentials before agent execution to prevent credential leakage into the agent session.
18. **Execute GitHub Copilot CLI** – Runs the GitHub Copilot CLI with the prepared prompt. The agent reads the changed YML files, analyzes their structure, and creates or updates the corresponding documentation files in `docs/`, then opens a pull request.
19. **Configure Git credentials** – Re-configures Git credentials after agent execution for any post-agent commit operations.
20. **Copy Copilot session state files to logs** – Copies Copilot session state to the logs folder for post-run inspection.
21. **Stop MCP Gateway** – Shuts down the MCP gateway process.
22. **Redact secrets in logs** – Scrubs secrets and sensitive values from log files before they are uploaded.
23. **Upload Safe Outputs** – Uploads the safe output payloads (e.g., pull request creation requests) as artifacts for the `safe_outputs` job.
24. **Ingest agent output** – Parses the raw agent output and extracts structured result data.
25. **Upload sanitized agent output** – Uploads the sanitized agent output as an artifact.
26. **Upload engine output files** – Uploads additional engine-generated files as artifacts.
27. **Parse agent logs for step summary** – Extracts key events from agent logs and writes them to the GitHub Actions step summary.
28. **Parse MCP Gateway logs for step summary** – Extracts MCP gateway events and appends them to the step summary.
29. **Print firewall logs** – Outputs firewall/network policy logs for security auditing.
30. **Upload agent artifacts** – Bundles and uploads all remaining agent artifacts (logs, outputs, state).
31. **Check if detection needed** – Determines whether threat detection should run based on the agent's output.
32. **Clear MCP configuration for detection** – Resets the MCP configuration before the threat detection agent runs.
33. **Prepare threat detection files** – Prepares agent output files for threat detection analysis.
34. **Setup threat detection** – Installs and configures threat detection tooling.
35. **Ensure threat-detection directory and log** – Creates the threat detection log directory if it does not exist.
36. **Execute GitHub Copilot CLI** (threat detection) – Runs a secondary Copilot CLI invocation to analyze agent behavior for prompt injection or policy violations.
37. **Parse threat detection results** – Reads and interprets the threat detection output.
38. **Upload threat detection log** – Uploads the threat detection log as an artifact.
39. **Set detection conclusion** – Sets the job output indicating whether threat detection passed or failed.

---

### conclusion

**Runs on**: `ubuntu-slim`  
**Needs**: `activation`, `agent`  
**Condition**: Always runs when `agent` was not skipped

Processes the agent's final output and handles success, failure, no-op, and pull request error outcomes.

**Steps**:

1. **Setup Scripts** – Installs gh-aw action scripts.
2. **Download agent output artifact** – Downloads the agent output artifact from the `agent` job.
3. **Setup agent output environment variable** – Sets the `GH_AW_AGENT_OUTPUT` environment variable from the artifact.
4. **Process No-Op Messages** – Checks if the agent reported a no-op and records it.
5. **Record Missing Tool** – If the agent reported a missing tool error, records it in the workflow summary.
6. **Handle Agent Failure** – Marks the job as failed and outputs a summary if the agent failed.
7. **Handle No-Op Message** – Logs the no-op message if the agent found nothing to document (e.g., no documentation changes needed).
8. **Handle Create Pull Request Error** – If the pull request creation failed, logs the error and provides guidance on how to resolve it.

---

### safe_outputs

**Runs on**: `ubuntu-slim`  
**Needs**: `agent`, `conclusion`  
**Condition**: Runs when `agent` was not cancelled/skipped and threat detection passed

Processes the safe output payloads from the agent, including creating the pull request with documentation changes.

**Steps**:

1. **Setup Scripts** – Installs gh-aw action scripts.
2. **Download agent output artifact** – Downloads the agent output artifact.
3. **Setup agent output environment variable** – Sets the `GH_AW_AGENT_OUTPUT` environment variable.
4. **Download patch artifact** – Downloads the patch file containing the documentation file changes produced by the agent.
5. **Checkout repository** – Checks out the repository to apply the patch.
6. **Configure Git credentials** – Configures Git user and credentials for committing the documentation changes.
7. **Process Safe Outputs** – Applies the documentation changes and creates a pull request on the repository with the new or updated files in `docs/`.
8. **Upload safe output items manifest** – Uploads a manifest of all safe output items processed in this run.
