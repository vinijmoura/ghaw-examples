# Daily Repo Status

## Overview

This workflow creates daily repository status reports. It gathers recent repository activity (issues, pull requests, discussions, releases, and code changes) and generates engaging GitHub issues with productivity insights, community highlights, and project recommendations. The workflow is auto-generated by the gh-aw (GitHub Agentic Workflows) framework and should not be edited directly.

## Triggers

- **schedule** – Runs daily at 14:45 UTC (cron: `45 14 * * *`)
- **workflow_dispatch** – Can be triggered manually from the GitHub Actions UI

## Permissions

No top-level permissions are defined; permissions are scoped per job.

## Environment Variables

No workflow-level environment variables are defined.

## Jobs

### activation

**Runs on**: `ubuntu-slim`

**Permissions**: `contents: read`

This job prepares the agentic prompt and validates all context before handing off to the `agent` job.

**Steps**:

1. **Setup Scripts** – Installs the gh-aw action scripts to `/opt/gh-aw/actions` using `github/gh-aw/actions/setup`.
2. **Validate context variables** – Runs a script to ensure all required GitHub context variables (actor, repository, workspace, etc.) are present and valid.
3. **Checkout .github and .agents folders** – Sparsely checks out only the `.github` and `.agents` directories to avoid fetching unnecessary history.
4. **Check workflow file timestamps** – Validates that the workflow file (`daily-repo-status.lock.yml`) has not been tampered with or run out of order.
5. **Create prompt with built-in context** – Assembles the agentic prompt by concatenating built-in system prompts (XPIA protection, temp folder setup, markdown rules, safe outputs) with the workflow-specific instructions and injecting GitHub context environment variables.
6. **Interpolate variables and render templates** – Processes Handlebars-style template directives in the prompt file, including any `{{#runtime-import}}` references to other files in the repository.
7. **Substitute placeholders** – Replaces `__GH_AW_*__` placeholder tokens in the prompt with actual runtime values (actor, repository, run ID, etc.).
8. **Validate prompt placeholders** – Checks that no unsubstituted placeholders remain in the final prompt.
9. **Print prompt** – Outputs a summary of the final prompt to the Actions log for debugging.
10. **Upload prompt artifact** – Uploads the fully assembled prompt as a GitHub Actions artifact so the `agent` job can download and use it.

---

### agent

**Runs on**: `ubuntu-latest`  
**Needs**: `activation`

This job executes the AI agent (GitHub Copilot CLI) that reads the prepared prompt and generates the daily status report. It also handles threat detection and uploads all outputs.

**Steps**:

1. **Setup Scripts** – Installs gh-aw action scripts.
2. **Checkout repository** – Checks out the full repository for the agent to read.
3. **Create gh-aw temp directory** – Creates `/tmp/gh-aw/agent/` as a writable workspace for temporary files.
4. **Configure Git credentials** – Sets up Git credentials (user name, email, token) so the agent can make commits if needed.
5. **Checkout PR branch** – If this run is associated with a pull request, checks out the PR branch.
6. **Generate agentic run info** – Writes metadata about the current run (workflow name, run ID, actor) into a file for the agent's context.
7. **Validate COPILOT_GITHUB_TOKEN secret** – Verifies the `COPILOT_GITHUB_TOKEN` secret is present and valid for authenticating the GitHub Copilot CLI.
8. **Install GitHub Copilot CLI** – Installs the `gh copilot` CLI extension used to run the AI agent.
9. **Install awf binary** – Installs the `awf` (agentic workflow framework) binary that orchestrates the agent execution.
10. **Download container images** – Pre-pulls container images required by the agent environment.
11. **Write Safe Outputs Config** – Writes the safe outputs configuration (allowed output types, schemas) to disk for the MCP server.
12. **Generate Safe Outputs MCP Server Config** – Generates the MCP server configuration file for the safe outputs server.
13. **Start Safe Outputs MCP HTTP Server** – Starts a local HTTP server that exposes safe output tools (e.g., `create_issue`) to the agent via the MCP protocol.
14. **Start MCP Gateway** – Starts the MCP gateway that routes tool calls between the agent and backend services (GitHub API, safe outputs, etc.) while enforcing security policies.
15. **Generate workflow overview** – Produces a high-level summary of the workflow for inclusion in the agent's context.
16. **Download prompt artifact** – Downloads the prompt artifact assembled by the `activation` job.
17. **Clean git credentials** – Removes stored Git credentials before executing the agent to prevent credential leakage.
18. **Execute GitHub Copilot CLI** – Runs the GitHub Copilot CLI with the prepared prompt, allowing the agent to gather repository activity data and produce the daily status report issue.
19. **Configure Git credentials** – Re-configures Git credentials after agent execution if commits are needed.
20. **Copy Copilot session state files to logs** – Copies the Copilot session state directory to the logs folder for post-run inspection.
21. **Stop MCP Gateway** – Shuts down the MCP gateway process.
22. **Redact secrets in logs** – Scrubs secrets and sensitive values from all log files before uploading.
23. **Upload Safe Outputs** – Uploads the safe output payloads (e.g., issue creation requests) as artifacts for the `safe_outputs` job to process.
24. **Ingest agent output** – Parses the raw agent output and extracts structured result data.
25. **Upload sanitized agent output** – Uploads the sanitized agent output as an artifact.
26. **Upload engine output files** – Uploads any additional engine-generated files as artifacts.
27. **Parse agent logs for step summary** – Extracts key events from agent logs and writes them to the GitHub Actions step summary.
28. **Parse MCP Gateway logs for step summary** – Extracts MCP gateway events and appends them to the step summary.
29. **Print firewall logs** – Outputs firewall/network policy logs to the Actions log for security auditing.
30. **Upload agent artifacts** – Bundles and uploads all remaining agent artifacts (logs, outputs, state).
31. **Check if detection needed** – Determines whether threat detection should be run based on the agent's output.
32. **Clear MCP configuration for detection** – Resets the MCP configuration before running the threat detection agent.
33. **Prepare threat detection files** – Prepares the agent output files for threat detection analysis.
34. **Setup threat detection** – Installs and configures the threat detection tooling.
35. **Ensure threat-detection directory and log** – Creates the threat detection log directory if it does not exist.
36. **Execute GitHub Copilot CLI** (threat detection) – Runs a secondary Copilot CLI invocation to analyze agent behavior for prompt injection or policy violations.
37. **Parse threat detection results** – Reads and interprets the threat detection output.
38. **Upload threat detection log** – Uploads the threat detection log as an artifact.
39. **Set detection conclusion** – Sets the job output indicating whether the threat detection passed or failed.

---

### conclusion

**Runs on**: `ubuntu-slim`  
**Needs**: `activation`, `agent`  
**Condition**: Always runs when `agent` was not skipped

This job processes the agent's final output and handles success, failure, and no-op outcomes.

**Steps**:

1. **Setup Scripts** – Installs gh-aw action scripts.
2. **Download agent output artifact** – Downloads the agent output artifact from the `agent` job.
3. **Setup agent output environment variable** – Sets the `GH_AW_AGENT_OUTPUT` environment variable from the artifact contents.
4. **Process No-Op Messages** – Checks if the agent reported a no-op (nothing to do) and records it.
5. **Record Missing Tool** – If the agent reported a missing tool error, records it in the workflow summary.
6. **Handle Agent Failure** – If the agent failed, marks the job as failed and outputs a failure summary.
7. **Handle No-Op Message** – If the agent issued a no-op, logs the no-op message and marks the workflow as complete without action.

---

### safe_outputs

**Runs on**: `ubuntu-slim`  
**Needs**: `agent`  
**Condition**: Runs when `agent` was not cancelled/skipped and threat detection passed

This job processes the safe output payloads produced by the agent (e.g., creating GitHub issues).

**Steps**:

1. **Setup Scripts** – Installs gh-aw action scripts.
2. **Download agent output artifact** – Downloads the agent output artifact.
3. **Setup agent output environment variable** – Sets the `GH_AW_AGENT_OUTPUT` environment variable.
4. **Process Safe Outputs** – Executes the safe output actions (e.g., calling the GitHub API to create issues) using the payloads approved by the agent and validated by the safe outputs server.
5. **Upload safe output items manifest** – Uploads a manifest of all safe output items processed in this run.
